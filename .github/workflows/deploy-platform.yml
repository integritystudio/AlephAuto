name: CD - Platform Deployment (Railway/Render/Heroku)

# This workflow is for deploying to platforms like Railway, Render, or Heroku
# These platforms handle the deployment process automatically via git push

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  validate:
    name: Validate Before Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          npm ci
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          npm test
          npm run typecheck

      - name: Validate deployment configuration
        run: |
          echo "Validating deployment configuration..."

          # Check for Procfile (Heroku)
          if [ -f Procfile ]; then
            echo "‚úÖ Procfile found"
            cat Procfile
          fi

          # Check for railway.json (Railway)
          if [ -f railway.json ]; then
            echo "‚úÖ railway.json found"
            cat railway.json
          fi

          # Check for render.yaml (Render)
          if [ -f render.yaml ]; then
            echo "‚úÖ render.yaml found"
            cat render.yaml
          fi

          # Validate dashboard files
          test -f public/index.html || (echo "‚ùå Dashboard not found" && exit 1)
          test -f api/server.js || (echo "‚ùå API server not found" && exit 1)

          echo "‚úÖ Deployment configuration validated"

  notify:
    name: Deployment Notification
    needs: validate
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Notify success
        run: |
          echo "‚úÖ Validation passed"
          echo "üöÄ Platform will deploy automatically via git push"
          echo ""
          echo "Deployment checklist:"
          echo "  ‚úÖ Tests passed"
          echo "  ‚úÖ TypeScript validated"
          echo "  ‚úÖ Dashboard files present"
          echo "  ‚úÖ API server validated"
          echo ""
          echo "Next steps:"
          echo "  1. Platform (Railway/Render/Heroku) will detect push to main"
          echo "  2. Platform will run build/start commands"
          echo "  3. Dashboard will be available at platform URL"
          echo ""
          echo "Monitor deployment at your platform's dashboard."
