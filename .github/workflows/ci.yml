name: CI - Tests and Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]
        python-version: ['3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install Node.js dependencies
        run: pnpm install --frozen-lockfile

      - name: Install ast-grep (best effort)
        run: pnpm add -g @ast-grep/cli@latest || echo "⚠️ ast-grep installation failed (non-critical)"
        continue-on-error: true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify Python pipeline availability
        run: |
          echo "Verifying Python pipeline dependencies..."
          python3 -c "import pydantic; print(f'✅ pydantic {pydantic.__version__} available')"
          python3 -c "import sys; print(f'✅ Python {sys.version} available')"

      - name: Verify setup
        run: pnpm run verify

      - name: Run TypeScript type checking
        run: pnpm run typecheck

      - name: Run unit tests
        run: pnpm test

      - name: Run integration tests
        env:
          NODE_ENV: test
          CI: true
        run: pnpm run test:integration
        continue-on-error: true  # Integration tests may need external services

      - name: Check dashboard files exist
        run: |
          test -f public/index.html || exit 1
          test -f public/dashboard.css || exit 1
          test -f public/dashboard.js || exit 1
          echo "✅ Dashboard files verified"

      - name: Test Python pipeline integration
        run: |
          echo "Testing Python pipeline stages (3-7)..."

          # Verify pydantic models load correctly
          python3 << 'PYEOF'
          import sys
          sys.path.insert(0, 'sidequest/pipeline-core')
          from models.code_block import CodeBlock, SourceLocation
          from models.duplicate_group import DuplicateGroup
          print('✅ Pydantic models imported successfully')
          PYEOF

          # Test structural similarity module
          python3 << 'PYEOF'
          import sys
          sys.path.insert(0, 'sidequest/pipeline-core')
          from similarity.structural import calculate_structural_similarity
          score = calculate_structural_similarity('function a() { return 1; }', 'function b() { return 1; }')
          assert 0 <= score <= 1, f'Invalid score: {score}'
          print(f'✅ Structural similarity working (score: {score:.2f})')
          PYEOF

          echo "✅ Python pipeline integration verified"

  lint:
    name: Lint and Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install ast-grep (best effort)
        run: pnpm add -g @ast-grep/cli@latest || echo "⚠️ ast-grep installation failed (non-critical)"
        continue-on-error: true

      - name: TypeScript type checking
        run: pnpm run typecheck

      - name: Check for security vulnerabilities
        run: pnpm audit --audit-level=high

  build-validation:
    name: Validate Build & Static Assets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install ast-grep (best effort)
        run: pnpm add -g @ast-grep/cli@latest || echo "⚠️ ast-grep installation failed (non-critical)"
        continue-on-error: true

      - name: Validate static assets
        run: |
          # Check that public directory exists
          test -d public || (echo "❌ public/ directory not found" && exit 1)

          # Check HTML structure
          grep -q "AlephAuto Dashboard" public/index.html || (echo "❌ Dashboard title not found" && exit 1)

          # Check CSS file size (should be reasonable)
          SIZE=$(stat -f%z public/dashboard.css 2>/dev/null || stat -c%s public/dashboard.css)
          if [ $SIZE -lt 1000 ]; then
            echo "❌ CSS file too small: $SIZE bytes"
            exit 1
          fi

          # Check JS file size
          SIZE=$(stat -f%z public/dashboard.js 2>/dev/null || stat -c%s public/dashboard.js)
          if [ $SIZE -lt 5000 ]; then
            echo "❌ JS file too small: $SIZE bytes"
            exit 1
          fi

          echo "✅ Static assets validated"

      - name: Test API server starts
        run: |
          # Start server in background
          timeout 30 node api/server.js &
          SERVER_PID=$!

          # Wait for server to be ready (retry up to 15 seconds)
          echo "Waiting for server to start..."
          for i in {1..15}; do
            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
              echo "✅ Server ready after ${i} seconds"
              break
            fi
            if [ $i -eq 15 ]; then
              echo "❌ Server failed to start within 15 seconds"
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done

          # Test health endpoint
          curl -f http://localhost:8080/health || (echo "❌ Health check failed" && exit 1)

          # Clean up
          kill $SERVER_PID 2>/dev/null || true

          echo "✅ API server validated"
        env:
          NODE_ENV: test
          JOBS_API_PORT: 8080
