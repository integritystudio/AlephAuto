#!/usr/bin/env sh

# Pre-commit hook for AlephAuto
# Validates test files for hardcoded paths before allowing commit
#
# Note: This hook works standalone without husky.sh dependency

echo "üîç Running pre-commit checks..."

# Auto-sync Cloudflare tunnel files if needed
echo "Syncing Cloudflare tunnel files..."
SYNC_OUTPUT=$(node scripts/sync-cloudflare-tunnel-files.js 2>&1)
SYNC_STATUS=$?

if [ $SYNC_STATUS -ne 0 ]; then
  echo ""
  echo "‚ùå Cloudflare tunnel sync failed!"
  echo "$SYNC_OUTPUT"
  exit 1
fi

# Check if any files were synced (not already in sync)
if echo "$SYNC_OUTPUT" | grep -q "SYNCED:"; then
  echo "üì¶ Auto-synced Cloudflare tunnel files, staging them..."
  # Stage the synced destination files
  git add api/routes/routes/*.js api/routes/middleware/*.js 2>/dev/null || true
fi

# Check for dangerous eval() usage (CWE-95 security vulnerability)
echo "Checking for dangerous eval() usage..."
EVAL_FILES=$(git diff --cached --name-only --diff-filter=ACMR | xargs grep -l "eval\s*(" 2>/dev/null | grep -E '\.(js|ts|jsx|tsx)$' || true)

if [ -n "$EVAL_FILES" ]; then
  echo ""
  echo "‚ùå Pre-commit validation failed!"
  echo "Dangerous eval() usage detected in staged files:"
  echo ""
  for file in $EVAL_FILES; do
    echo "  - $file"
    grep -n "eval\s*(" "$file" | head -5 | sed 's/^/      /'
  done
  echo ""
  echo "eval() allows arbitrary code execution (CWE-95)."
  echo "Use safe alternatives:"
  echo "  - JSON.parse() for JSON parsing"
  echo "  - obj[propertyName] for dynamic property access"
  echo "  - createRequire() for loading CommonJS modules"
  echo "  - new Function() with validation for dynamic code (if absolutely necessary)"
  echo ""
  exit 1
fi

# Check for hardcoded test paths
echo "Validating test paths..."
npm run test:validate-paths

if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå Pre-commit validation failed!"
  echo "Fix hardcoded paths in test files before committing."
  echo ""
  echo "Run 'npm run test:validate-paths' to see issues."
  echo ""
  exit 1
fi

# Check executable permissions and shebangs on pipeline files
echo "Checking executable permissions and shebangs..."
MISSING_EXEC=0
MISSING_SHEBANG=0

# Check each pipeline file
for file in api/server.js sidequest/pipeline-runners/*.js; do
  if [ -f "$file" ]; then
    # Check executable permissions
    if [ ! -x "$file" ]; then
      echo "‚ùå Missing executable permission: $file"
      MISSING_EXEC=1
    fi

    # Check shebang
    FIRST_LINE=$(head -n 1 "$file")
    if [ "$FIRST_LINE" != "#!/usr/bin/env node" ]; then
      echo "‚ùå Missing or incorrect shebang in: $file"
      echo "   Expected: #!/usr/bin/env node"
      echo "   Found: $FIRST_LINE"
      MISSING_SHEBANG=1
    fi
  fi
done

if [ $MISSING_EXEC -eq 1 ]; then
  echo ""
  echo "‚ùå Pre-commit validation failed!"
  echo "Pipeline files must be executable for PM2/Doppler to run them."
  echo ""
  echo "Fix with: chmod +x api/server.js sidequest/pipeline-runners/*.js"
  echo ""
  exit 1
fi

if [ $MISSING_SHEBANG -eq 1 ]; then
  echo ""
  echo "‚ùå Pre-commit validation failed!"
  echo "All pipeline runner files must have shebang: #!/usr/bin/env node"
  echo ""
  echo "This ensures they can be executed directly by Doppler/PM2."
  echo ""
  exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
